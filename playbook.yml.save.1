---
- hosts: ansible-target
  become: yes
  tasks:
    - name: Get software for apt repository management.
      apt: name={{ item }} state=present
      with_items:
        - python-apt
        - python-pycurl

    - name: "Install Apache, MySQL, PHP, and other dependencies."
      apt: name={{ item }} state=present
      with_items:
        - apache2
        - apache2-utils
        - php7.4
        - php7.4-mysql
        - php7.4-cli
        - php7.4-cgi
        - php7.4-gd
        - libapache2-mod-php7.4
        - mariadb-server
        - mariadb-client

    - name: Create document root
      file:
        path: "/var/www/task"
        state: directory
        owner: "www-data"
        group: "www-data"
        mode: '0755'

    - name: Rename default Apache conf
      command: mv /etc/apache2/sites-available/000-default.conf /etc/apache2/sites-available/_000-default.conf

    - name: Copy new Apache conf
      copy:
        src: /home/$USER/project/files/apache.conf
        dest: /etc/apache2/sites-available/apache.conf

    - name: Symlink Drupal virtualhost to sites-enabled.
      file:
        src: "/etc/apache2/sites-available/apache.conf"
        dest: "/etc/apache2/sites-enabled/apache.conf"
        state: link
      notify: restart apache

    - name: Enable Apache rewrite module (required for Drupal).
      apache2_module: name=rewrite state=present
      notify: restart apache

  # MySQL Configuration
    - name: Set the root password
      mysql_user:
        name: root
        password: "1155144b!"
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Remove the MySQL test database.
      mysql_db: 
        db=test 
        state=absent
        login_user: root
        login_password: "1155144b!"

    - name: Create a database for task.
      mysql_db: "db=task


    - name: "Start Apache, MySQL, and PHP."
      service: "name={{ item }} state=started enabled=yes"
      with_items:
        - apache2
        - mysql
